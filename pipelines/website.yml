resource_types:
  - name: concourse-pipeline
    type: docker-image
    source:
      repository: concourse/concourse-pipeline-resource

  - name: file-url
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/concourse-url-resource

resources:
  - name: pipelines
    type: concourse-pipeline
    source:
      target: http://concourse-web:8080/
      teams:
      - name: cw
        username: cw
        password: ((concourse.team-pass))

  - name: census-website-cms
    type: git
    source:
      uri: git@github.com:ONSdigital/census-website-cms.git
      private_key: ((github.census-website-cms))

  - name: census-website-generator
    type: git
    source:
      uri: git@github.com:ONSdigital/census-website-generator.git
      private_key: ((github.census-website-generator))

  - name: census-website-generator-pipelines
    type: git
    source:
      uri: git@github.com:ONSdigital/census-website-generator.git
      paths:
      - "pipelines"
      private_key: ((github.census-website-generator))
      
  - name: census-website-generator-concourse-url-resource
    type: git
    source:
      uri: git@github.com:ONSdigital/census-website-generator.git
      paths:
      - "docker-images/concourse-url-resource"
      private_key: ((github.census-website-generator))

  - name: census-website-generator-tags
    type: git
    source:
      uri: git@github.com:ONSdigital/census-website-generator.git
      private_key: ((github.census-website-generator))
      tag_filter: "*"

  - name: craft-cms-docker-image
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/craftcms
      username: _json_key
      password: ((gcp.service_account_json))
      
  - name: concourse-url-resource-docker-image
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/concourse-url-resource
      username: _json_key
      password: ((gcp.service_account_json))

  - name: census-website-generator-docker-image
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/website-generator
      username: _json_key
      password: ((gcp.service_account_json))

  - name: census-website-docker-image
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/website
      username: _json_key
      password: ((gcp.service_account_json))
      
  - name: census-website-docker-image-prod
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/website
      tag: prod
      username: _json_key
      password: ((gcp.service_account_json))
  
  - name: census-website-docker-image-blacklodge
    type: docker-image
    source:
      repository: eu.gcr.io/census-gcr-cw/website
      tag: blacklodge
      username: _json_key
      password: ((gcp.service_account_json))

  - name: entries-lastupdated
    type: file-url
    source:
      url: http://craftcms/api/entries.json
      filename: entries-lastupdated.json

  - name: assets
    type: file-url
    source:
      url: http://craftcms/api/assets.json
      filename: assets.json

  - name: entries-en
    type: file-url
    source:
      url: http://craftcms/api/entries-en.json
      filename: entries-en.json
  - name: entries-cy
    type: file-url
    source:
      url: http://craftcms/api/entries-cy.json
      filename: entries-cy.json
  - name: entries-ni
    type: file-url
    source:
      url: http://craftcms/api/entries-ni.json
      filename: entries-ni.json
  - name: globals-en
    type: file-url
    source:
      url: http://craftcms/api/globals-en.json
      filename: globals-en.json
  - name: globals-cy
    type: file-url
    source:
      url: http://craftcms/api/globals-cy.json
      filename: globals-cy.json
  - name: globals-ni
    type: file-url
    source:
      url: http://craftcms/api/globals-ni.json
      filename: globals-ni.json
jobs:
  - name: fly-pipeline
    plan:
    - get: census-website-generator-pipelines
      trigger: true
    - put: pipelines
      params:
        pipelines:
        - name: website
          team: cw
          config_file: census-website-generator-pipelines/pipelines/website.yml

  - name: set-secrets
    plan:
      - task: set-secrets
        config:
          platform: linux
          image_resource:
            type: registry-image
            source: 
              repository: gcr.io/cloud-builders/kubectl
          params:
            SERVICE_ACCOUNT_JSON: ((gcp.service_account_json))
          run:
            path: /bin/bash
            args:
              - -ce
              - |-
                cat >~/gcloud-service-key.json <<EOL
                $SERVICE_ACCOUNT_JSON
                EOL

                gcloud auth activate-service-account --key-file ~/gcloud-service-key.json
                gcloud container clusters get-credentials k8s-cd --zone europe-west2 --project census-ci
                
                echo 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 | base64 | gcloud kms decrypt --project census-ci --location europe-west2 --keyring concourse --key cw --plaintext-file census-website-cms --ciphertext-file -

                echo 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 | base64 | gcloud kms decrypt --project census-ci --location europe-west2 --keyring concourse --key cw --plaintext-file census-website-generator --ciphertext-file -
                
                kubectl create secret generic github -n concourse-cw --from-file=census-website-cms --from-file=census-website-generator --dry-run -o yaml | kubectl apply -f -

  - name: build-craft
    plan:
    - get: census-website-cms
      trigger: true
    - put: craft-cms-docker-image
      params:
        build: census-website-cms
      get_params:
        skip_download: true

  - name: build-concourse-url-resource
    plan:
    - get: census-website-generator-concourse-url-resource
      trigger: true
    - put: concourse-url-resource-docker-image
      params:
        build: census-website-generator-concourse-url-resource/docker-images/concourse-url-resource
      get_params:
        skip_download: true

  - name: build-generator
    plan:
    - get: census-website-generator
      trigger: true
    - put: census-website-generator-docker-image
      params:
        build: census-website-generator
        dockerfile: census-website-generator/Dockerfile.generator
      get_params:
        skip_download: true
  - name: build-generator-release
    plan:
    - get: census-website-generator-tags
      trigger: true
    - put: census-website-generator-docker-image
      params:
        tag: census-website-generator-tags/.git/ref
        build: census-website-generator-tags
        dockerfile: census-website-generator-tags/Dockerfile.generator
      get_params:
        skip_download: true

  - name: copy-entries
    plan:
    - get: entries-lastupdated
      trigger: true
    - get: assets
    - get: entries-en
    - get: entries-cy
    - get: entries-ni
    - get: globals-en
    - get: globals-cy
    - get: globals-ni
    - task: copy
      config:
        inputs:
          - name: assets
          - name: entries-en
          - name: entries-cy
          - name: entries-ni
          - name: globals-en
          - name: globals-cy
          - name: globals-ni
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: google/cloud-sdk
        params:
          SERVICE_ACCOUNT_JSON: ((gcp.service_account_json))
        run:
          path: sh
          args:
            - "-exc"
            - |
              cat >~/gcloud-service-key.json <<EOL
              $SERVICE_ACCOUNT_JSON
              EOL

              gcloud auth activate-service-account --key-file ~/gcloud-service-key.json

              gsutil cp assets/assets.json entries-en/entries-en.json entries-cy/entries-cy.json entries-ni/entries-ni.json globals-en/globals-en.json globals-cy/globals-cy.json  globals-ni/globals-ni.json gs://census-ci-craftcms/

  - name: build-website
    plan:
    - get: entries-lastupdated
      trigger: true
      passed:
        - copy-entries
    - get: census-website-generator-docker-image
      trigger: true
      passed:
        - build-generator
    - task: copy
      config:
        outputs:
          - name: docker-build
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: ubuntu
        run:
          path: sh
          args:
            - "-exc"
            - |
              cat >docker-build/Dockerfile <<EOL
              FROM eu.gcr.io/census-gcr-cw/website-generator as builder
              RUN npm run generate-site

              FROM nginx

              COPY --from=builder /website/nginx/entrypoint.sh /etc/entrypoint.sh
              COPY --from=builder /website/nginx/default.conf.template /etc/nginx/conf.d/default.conf.template
              COPY --from=builder /website/dist /usr/share/nginx/html

              ENV EN_HOST localhost-en
              ENV CY_HOST localhost-cy

              ENTRYPOINT ["/etc/entrypoint.sh"]
              EOL
    - put: census-website-docker-image
      params:
        build: docker-build
      get_params:
        skip_download: true

  - name: build-website-prod
    plan:
    - get: entries-lastupdated
      trigger: true
      passed:
        - copy-entries
    - task: copy
      config:
        outputs:
          - name: docker-build
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: ubuntu
        run:
          path: sh
          args:
            - "-exc"
            - |
              cat >docker-build/Dockerfile <<EOL
              FROM eu.gcr.io/census-gcr-cw/website-generator:v1.4.9 as builder
              RUN npm run generate-site

              FROM nginx

              COPY --from=builder /website/nginx/entrypoint.sh /etc/entrypoint.sh
              COPY --from=builder /website/nginx/default.conf.template /etc/nginx/conf.d/default.conf.template
              COPY --from=builder /website/dist /usr/share/nginx/html

              ENV EN_HOST localhost-en
              ENV CY_HOST localhost-cy

              ENTRYPOINT ["/etc/entrypoint.sh"]
              EOL
    - put: census-website-docker-image-prod
      params:
        build: docker-build
      get_params:
        skip_download: true

  - name: build-website-blacklodge
    plan:
    - get: entries-lastupdated
      trigger: true
      passed:
        - copy-entries
    - task: copy
      config:
        outputs:
          - name: docker-build
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: ubuntu
        run:
          path: sh
          args:
            - "-exc"
            - |
              cat >docker-build/Dockerfile <<EOL
              FROM eu.gcr.io/census-gcr-cw/website-generator:v1.4.10 as builder
              RUN npm run generate-site
              FROM nginx
              COPY --from=builder /website/nginx/entrypoint.sh /etc/entrypoint.sh
              COPY --from=builder /website/nginx/default.conf.template /etc/nginx/conf.d/default.conf.template
              COPY --from=builder /website/dist /usr/share/nginx/html
              ENV EN_HOST localhost-en
              ENV CY_HOST localhost-cy
              ENTRYPOINT ["/etc/entrypoint.sh"]
              EOL
    - put: census-website-docker-image-blacklodge
      params:
        build: docker-build
      get_params:
        skip_download: true
